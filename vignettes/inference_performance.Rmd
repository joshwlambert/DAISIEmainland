---
title: "Inference Performance"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Inference Performance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The DAISIEmainland package has several dependencies (the entire list can be
found in the DESCRIPTION). Most of these are on CRAN and can be installed with
`install.packages()`. However, the DAISIE and nLTT packages require more
up-to-date version than available on CRAN and need to be installed from github,
see instructions in the README for installing these packages. 

Load the DAISIEmainland package with the `library()` function. This will also
load the package dependencies, specifically the DAISIE package which will be
used later on for parameter estimation by fitting maximum likelihood models.

```{r load package}
library(DAISIEmainland)
```

First, we simulate an island. This will produce phylogenetic data for a single
island. In an analysis many more replicates (e.g. 1,000) would be required to 
account for the stochastic differences between replicates given the simulation
is stochastic. 

```{r Run simulation}
set.seed(
  1,
  kind = "Mersenne-Twister",
  normal.kind = "Inversion",
  sample.kind = "Rejection")

replicates <- 1

island <- DAISIEmainland::sim_island_with_mainland(
  total_time = 1,
  m = 100,
  island_pars = c(1, 1, 50, 0.1, 1),
  mainland_ex = 0.5,
  mainland_sample_prob = 1,
  mainland_sample_type = "complete",
  replicates = replicates,
  verbose = FALSE
)
```

Now we have the data (stored in the island object), which is a list object.
At the highest level of the list there are two lists (`island$ideal_islands` and
`island$empirical_islands`). The first (`island$ideal_islands`) contains 1
element, if more replicates where run each element of `island$ideal_islands` 
is one replicate. The `island$ideal_islands` and `island$empirical_islands` 
have the same structure. The first element of each is the `island_age` and the 
number of species `not_present` on the island that are on the mainland.

```{r Inspect data part 1}
island$ideal_islands[[1]][[1]]
island$empirical_islands[[1]][[1]]
```

Subsequent elements of the list are the island clades which are composed of:
`branching_times`, status of colonisation or `stac`, and number of
`missing_species`.

```{r Inspect data part 2}
island$ideal_islands[[1]][[2]]
island$empirical_islands[[1]][[2]]
```
  
To run a maximum likelihood DAISIE model on each replicate we create objects to
store the data in (`ideal_ml` and `empirical_ml`) and then loop over each
replicate.

```{r Calculate parameter estimates}
ideal_ml <- vector("list", replicates)
empirical_ml <- vector("list", replicates)

for (i in seq_len(replicates)) {
  ideal_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = island$ideal_islands[[i]],
    initparsopt = c(1, 1, 50, 0.1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    methode = "odeint::runge_kutta_fehlberg78",
    optimmethod = "simplex",
    jitter = 1e-5)
  
  empirical_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = island$empirical_islands[[i]],
    initparsopt = c(1, 1, 50, 0.1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    methode = "odeint::runge_kutta_fehlberg78",
    optimmethod = "simplex",
    jitter = 1e-5)
}
```

To calculate the errors we can run `calc_error()` with the simulated data and 
the maximum likelihood estimates.

```{r Calculate error}
errors <- DAISIEmainland::calc_error(
  daisie_data = island,
  ideal_ml = ideal_ml,
  empirical_ml = empirical_ml)
```

The errors are: 

(1) Delta CTT (difference in colonisations through time) between
the ideal and empirical data.

```{r Display Delta CTT}
errors$delta_ctt
```

(2) Percentage of maximum island age colonisations (i.e. colonisations where
the most recent colonisation time extracted from the phylogenetic data is older
than the island) for the ideal and empirical data (only included colonisations 
that survive to the present). The ideal max age percentage is always zero as it
is always known exactly when the species colonised the island, but is still
calculated to check it is zero. The empirical max age percent can be any
percent [0, 100].

```{r Display Max age percentages}
errors$max_age_percent
```

(3) Percent of endemic species at the present. This includes counts of the 
number of endemic and non-endemic species in the ideal and empirical data, as 
well as the calculation of the percentage of endemic species in each data set.

```{r Display Endemic percentages}
errors$endemic_percent
```

(4) Parameter estimate ratios (i.e. ideal parameter estimates divided by its
corresponding empirical parameter estimate), for cladogenesis (\$clado_ratio),
extinction (\$ext_ratio), carrying capacity (\$k_ratio), colonisation
(\$immig_ratio), and anagenesis (\$ana_ratio). All parameters were estimated
using the DAISIE maximum likelihood model (`DAISIE::DAISIE_ML_CS()`). These
metrics show the difference
in estimation of each parameter between [0, Inf].

```{r Display Parameter estimate ratios}
errors$endemic_percent
```

For the code used to run the analysis for Lambert et al. (2021) see the
`run_analysis.R` script and for plotting see `run_post_processing.R` script.
