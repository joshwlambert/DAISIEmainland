---
title: "examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The DAISIEmainland package has several dependencies (the entire list can be
found in the DESCRIPTION). Most of these are on CRAN and can be installed with
`install.packages()`. However, two packages require more up-to-date version than
available on CRAN and need to be installed from github using the code below. 

```{r install dependencies}
remotes::install_github("rsetienne/DAISIE")
remotes::install_github("thijsjanzen/nLTT")
remotes::install_github("joshwlambert/DAISIEmainland")
```

Load the DAISIEmainland package with the `library()` function. This will also
load the package dependencies, specifically the DAISIE package which will be
used later on for parameter estimation by fitting maximum likelihood models.

```{r load package}
library(DAISIEmainland)
```

First, we simulate an island. This will produce phylogenetic data for a single
island. In an analysis many more replicates (e.g. 1,000) would be required to 
account for the stochastic differences between replicates given the simulation
is stochastic. 

```{r Run simulation}
set.seed(
  1,
  kind = "Mersenne-Twister",
  normal.kind = "Inversion",
  sample.kind = "Rejection")

replicates <- 1

island <- DAISIEmainland::sim_island_with_mainland(
  total_time = 1,
  m = 100,
  island_pars = c(1, 1, 50, 0.1, 1),
  mainland_ex = 0.5,
  mainland_sample_prob = 1,
  mainland_sample_type = "complete",
  replicates = replicates,
  verbose = FALSE
)
```

Now we have the data (stored in the island object), which is a list object.
At the highest level of the list there are two lists (`island$ideal_islands` and
`island$empirical_islands`). The first (`island$ideal_islands`) contains 1
elements, if more replicates where run each element of `island$ideal_islands` 
is one replicate. The `island$ideal_islands` and `island$empirical_islands` 
have the same structure. The first element of each is the `island_age` and the 
number of species `not_present` on the island that are on the mainland.

```{r Inspect data part 1}
island$ideal_islands[[1]][[1]]
island$empirical_islands[[1]][[1]]
```

Subsequent elements of the list are the island clades which are composed of:
`branching_times`, status of colonisation or `stac`, and number of
`missing_species`.

```{r Inspect data part 2}
island$ideal_islands[[1]][[2]]
island$empirical_islands[[1]][[2]]
```

We can now calculate the simulation metrics for the ideal and empirical islands.

```{r Calculate simulation metrics}
ideal_sim_metrics <- DAISIEmainland::calc_sim_metrics(
  daisie_data = island$ideal_islands)
empirical_sim_metrics <- DAISIEmainland::calc_sim_metrics(
  daisie_data = island$empirical_islands)

ideal_sim_metrics
empirical_sim_metrics
```
  
To run a maximum likelihood DAISIE model on each replicate we create objects to
store the data in (`ideal_ml` and `empirical_ml`) and then loop over each
replicate.

```{r Calculate parameter estimates}
ideal_ml <- vector("list", replicates)
empirical_ml <- vector("list", replicates)

for (i in seq_len(replicates)) {
  ideal_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = island$ideal_islands[[i]],
    initparsopt = c(1, 1, 10, 1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    jitter = 1e-5)
  
  empirical_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = island$empirical_islands[[i]],
    initparsopt = c(1, 1, 10, 1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    jitter = 1e-5)
}
```

To calculate the errors we can run `calc_error()` with the simulated data and 
the maximum likelihood estimates.

```{r Calculate error}
errors <- DAISIEmainland::calc_error(
  daisie_data = island,
  ideal_ml = ideal_ml,
  empirical_ml = empirical_ml)
```

For the code used to run the analysis for Lambert et al. (2021) see the
`run_analysis.R` script and for plotting see `run_post_processing.R` script.
