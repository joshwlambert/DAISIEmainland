# Inference performance {#Inference-performance}

One of the primary purposes of the `DAISIEmainland` package and specifically
why the data is formatted in the `DAISIE` format is to test the maximum 
likelihood inference models implemented in the `DAISIE` R package [@etienne_daisie_2022]. Therefore, in this section we explore how to conduct a
simple performance analysis of one of the `DAISIE` models. In this case we are
going to use the model with a single macroevolutionary regime on the island (
i.e. all island species are assumed to have the same rate of colonisation, 
speciation and extinction, as well as the same carrying capacity). This model
also assumes that the carrying capacity only operates between species within the
same island clade (termed clade-specific diversity-dependence), thus different
island colonists are supposed independent and not inhibiting the diversification
of each other.

As a small technical aside, this section uses `DAISIE` version 4.1.1. Re-running
this code on another system may produce different results, especially if a
different version of `DAISIE` is installed.

First, we simulate an island. This will produce phylogenetic data for a single
island. In an analysis many more replicates (e.g. 1,000) would be required to 
account for the stochastic differences between replicates given the simulation
is stochastic. 

```{r, load simulated data, echo=FALSE}
daisie_mainland_data <- readRDS(
  file = system.file(
    "inst/book/data/daisie_mainland_data_1000_rep.rds", 
    package = "DAISIEmainland")
)
```

```{r, Run simulation, eval=FALSE}
set.seed(
  1,
  kind = "Mersenne-Twister",
  normal.kind = "Inversion",
  sample.kind = "Rejection")

replicates <- 1

daisie_mainland_data <- DAISIEmainland::sim_island_with_mainland(
  total_time = 1,
  m = 100,
  island_pars = c(1, 1, 50, 0.1, 1),
  mainland_ex = 0.5,
  mainland_sample_prob = 1,
  mainland_sample_type = "complete",
  replicates = replicates,
  verbose = FALSE
)
```

Now we have the simulated data, stored in `daisie_mainland_data` (see section \@ref(daisie-mainland-data)), which is a list object.
At the highest level of the list there are two lists
(`daisie_mainland_data$ideal_multi_daisie_data` and
  `daisie_mainland_data$empirical_multi_daisie_data`). The first
(`daisie_mainland_data$ideal_multi_daisie_data`) contains 1
element, if more replicates where run each element of `daisie_mainland_data$ideal_multi_daisie_data` 
is one replicate. The `daisie_mainland_data$ideal_multi_daisie_data` and `daisie_mainland_data$empirical_multi_daisie_data` have the same structure.
The first element of each is the meta data, containing: `island_age` and the 
number of species `not_present` on the island that are on the mainland.

```{r Inspect data part 1}
daisie_mainland_data$ideal_multi_daisie_data[[1]][[1]]
daisie_mainland_data$empirical_multi_daisie_data[[1]][[1]]
```

Subsequent elements of the list are the island clades which are composed of:
`branching_times`, status of colonisation or `stac`, and number of
`missing_species`.

```{r Inspect data part 2}
daisie_mainland_data$ideal_multi_daisie_data[[1]][[2]]
daisie_mainland_data$empirical_multi_daisie_data[[1]][[2]]
```

To run a maximum likelihood DAISIE model on each replicate we create objects to
store the data in (`ideal_ml` and `empirical_ml`) and then loop over each
replicate. Here we lower the tolerance (`tol` argument) of the maximum
likelihood optimisation to increase the speed of optimisation. However, when 
using the `DAISIE_ML_CS()` function the default values will provide accurate
estimation to a sensible tolerance.

```{r, load ml data, echo=FALSE, eval=FALSE}
ideal_ml <- readRDS(
  file = system.file(
    "inst/book/data/daisie_mainland_data_1000_rep.rds", 
    package = "DAISIEmainland"
  )
)

empirical_ml <- readRDS(
  file = system.file(
    "inst/book/data/daisie_mainland_data_1000_rep.rds",
    package = "DAISIEmainland"
  )
)
```

```{r Calculate parameter estimates, eval=FALSE}
ideal_ml <- vector("list", replicates)
empirical_ml <- vector("list", replicates)

for (i in seq_len(replicates)) {
  ideal_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = daisie_mainland_data$ideal_multi_daisie_data[[i]],
    initparsopt = c(1, 1, 50, 0.1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    methode = "odeint::runge_kutta_fehlberg78",
    optimmethod = "simplex",
    tol = c(1e-01, 1e-02, 1e-04),
    jitter = 1e-5)
  
  empirical_ml[[i]] <- DAISIE::DAISIE_ML_CS(
    datalist = daisie_mainland_data$empirical_multi_daisie_data[[i]],
    initparsopt = c(1, 1, 50, 0.1, 1),
    idparsopt = 1:5,
    parsfix = NULL,
    idparsfix = NULL,
    ddmodel = 11,
    methode = "odeint::runge_kutta_fehlberg78",
    optimmethod = "simplex",
    tol = c(1e-01, 1e-02, 1e-04),
    jitter = 1e-5)
}
```

To calculate the errors we can run `calc_error()` with the simulated data and 
the maximum likelihood estimates.

```{r Calculate error, eval=FALSE}
errors <- DAISIEmainland::calc_error(
  daisie_mainland_data = daisie_mainland_data,
  ideal_ml = ideal_ml,
  empirical_ml = empirical_ml)
```

The errors are: 
  
(1) Delta CTT (difference in colonisations through time) between
the ideal and empirical data.

```{r Display Delta CTT, eval=FALSE}
errors$delta_ctt
```

(2) Percentage of maximum island age colonisations (i.e. colonisations where
the most recent colonisation time extracted from the phylogenetic data is older
than the island) for the ideal and empirical data (only included colonisations 
that survive to the present). The ideal max age percentage is always zero as it
is always known exactly when the species colonised the island, but is still
calculated to check it is zero. The empirical max age percent can be any
percent [0, 100].

```{r Display Max age percentages, eval=FALSE}
errors$max_age_percent
```

(3) Percent of endemic species at the present. This includes counts of the 
number of endemic and non-endemic species in the ideal and empirical data, as 
well as the calculation of the percentage of endemic species in each data set.

```{r Display Endemic percentages, eval=FALSE}
errors$endemic_percent
```

(4) Parameter estimate ratios (i.e. ideal parameter estimates divided by its
corresponding empirical parameter estimate), for cladogenesis (\$clado_ratio),
extinction (\$ext_ratio), carrying capacity (\$k_ratio), colonisation
(\$immig_ratio), and anagenesis (\$ana_ratio). All parameters were estimated
using the DAISIE maximum likelihood model (`DAISIE::DAISIE_ML_CS()`). These
metrics show the difference in estimation of each parameter between [0, Inf].

```{r Display Parameter estimate ratios, eval=FALSE}
errors$endemic_percent
```

For the code used to run the analysis for Lambert et al. (2021) see the
`run_analysis.R` script and for plotting see `run_post_processing.R` script.
